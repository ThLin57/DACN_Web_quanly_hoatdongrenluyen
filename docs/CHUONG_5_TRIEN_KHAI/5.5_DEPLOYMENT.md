# 5.5. TRIỂN KHAI HỆ THỐNG (DEPLOYMENT)

## Tổng quan

Chương này trình bày chi tiết quy trình triển khai hệ thống "Quản lý Hoạt động Rèn luyện sinh viên" từ môi trường phát triển local lên môi trường production trên **AWS EC2** với domain **hoatdongrenluyen.io.vn**.

**Công nghệ deployment:**
- **Cloud Provider:** Amazon Web Services (AWS)
- **Server:** EC2 Instance (Ubuntu 22.04 LTS)
- **Container:** Docker & Docker Compose
- **Reverse Proxy:** Nginx
- **Database:** PostgreSQL 15
- **SSL/TLS:** Let's Encrypt (Certbot)
- **SSH Client:** PuTTY (Windows)
- **File Transfer:** WinSCP
- **Version Control:** GitHub

---

## 5.5.1. Kiến trúc triển khai

### a) Sơ đồ kiến trúc hệ thống

```
┌────────────────────────────────────────────────────────────────┐
│                    INTERNET                                     │
│                        ↓↑                                       │
│                 hoatdongrenluyen.io.vn                          │
└────────────────────────────────────────────────────────────────┘
                         ↓↑
┌────────────────────────────────────────────────────────────────┐
│              AWS EC2 INSTANCE (Ubuntu 22.04)                    │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                NGINX (Port 80/443)                       │  │
│  │  - Reverse Proxy                                         │  │
│  │  - SSL/TLS Termination (Let's Encrypt)                   │  │
│  │  - Load Balancing                                        │  │
│  │  - Gzip Compression                                      │  │
│  │  - Security Headers                                      │  │
│  └──────────────────────────────────────────────────────────┘  │
│              ↓                           ↓                      │
│  ┌──────────────────────┐   ┌─────────────────────────────┐   │
│  │  DOCKER CONTAINER    │   │   DOCKER CONTAINER          │   │
│  │  Frontend (React)    │   │   Backend (Node.js)         │   │
│  │  - Port: 3000        │   │   - Port: 3001              │   │
│  │  - Build: npm build  │   │   - Express API             │   │
│  │  - Serve: nginx      │   │   - Prisma ORM              │   │
│  └──────────────────────┘   └─────────────────────────────┘   │
│                                      ↓                          │
│              ┌─────────────────────────────────────────┐       │
│              │   DOCKER CONTAINER                      │       │
│              │   PostgreSQL Database                   │       │
│              │   - Port: 5432                          │       │
│              │   - Volume: /var/lib/postgresql/data    │       │
│              │   - Persistent storage                  │       │
│              └─────────────────────────────────────────┘       │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │           DOCKER VOLUMES                                 │  │
│  │  - pgdata: Database persistent storage                   │  │
│  │  - logs: Application logs                                │  │
│  │  - uploads: User uploaded files                          │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                         ↓↑
┌────────────────────────────────────────────────────────────────┐
│              DEVELOPMENT ENVIRONMENT                            │
│  - Local Machine (Windows)                                     │
│  - PuTTY: SSH connection                                       │
│  - WinSCP: File transfer                                       │
│  - Git: Version control                                        │
│  - VS Code: Code editing                                       │
└────────────────────────────────────────────────────────────────┘
```

### b) Luồng dữ liệu (Data Flow)

```
User Browser
      ↓
   [HTTPS Request]
      ↓
hoatdongrenluyen.io.vn:443
      ↓
   Nginx (SSL Termination)
      ↓
   ┌─────────────────────┐
   │  Route Decision     │
   └─────────────────────┘
      ↓                ↓
   [/]             [/api/*]
      ↓                ↓
   Frontend      Backend API
   (React)       (Express)
   Port 3000     Port 3001
      ↓                ↓
   Return HTML   Query Database
   + Assets           ↓
      ↓          PostgreSQL
   Browser       Port 5432
   Render             ↓
      ↓          Return Data
   Display            ↓
                  JSON Response
                      ↓
                  Frontend
                      ↓
                  User Browser
```

---

## 5.5.2. Chuẩn bị môi trường AWS EC2

### a) Tạo EC2 Instance

**Bước 1: Đăng nhập AWS Console**
```
1. Truy cập: https://console.aws.amazon.com
2. Đăng nhập với tài khoản AWS
3. Chọn region: Asia Pacific (Singapore) ap-southeast-1
```

**Bước 2: Launch EC2 Instance**
```
EC2 Dashboard → Launch Instance

Cấu hình:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
- Name: student-activity-system
- OS: Ubuntu Server 22.04 LTS (64-bit x86)
- Instance Type: t2.medium (2 vCPU, 4 GB RAM)
- Key pair: Tạo mới "student-app-key.pem"
- Storage: 30 GB gp3 (SSD)
- Security Group: 
  + SSH (22) - My IP only
  + HTTP (80) - Anywhere (0.0.0.0/0)
  + HTTPS (443) - Anywhere (0.0.0.0/0)
  + Custom TCP (3000) - Anywhere (development)
  + Custom TCP (3001) - Anywhere (API)
  + PostgreSQL (5432) - My IP only
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**Bước 3: Lưu key pair (.pem file)**
```
File: student-app-key.pem
Location: C:\Users\[YourName]\Documents\AWS\
Permission: Chỉ Read-only cho user
```

### b) Chuyển đổi .pem sang .ppk (PuTTY format)

**Sử dụng PuTTYgen:**

**Bước 1: Mở PuTTYgen**
```
1. Download: https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html
2. Chạy: puttygen.exe
```

**Bước 2: Convert key**
```
1. Click "Load" → Chọn file student-app-key.pem
   (Chú ý: Đổi filter sang "All Files (*.*)")
2. Click "Save private key" → Lưu thành student-app-key.ppk
3. Bỏ qua warning về passphrase (hoặc thêm passphrase nếu muốn)
```

**File output:**
```
C:\Users\[YourName]\Documents\AWS\student-app-key.ppk
```

### c) Kết nối SSH với PuTTY

**Bước 1: Lấy Public IP của EC2**
```
AWS Console → EC2 → Instances
→ Chọn instance → Copy Public IPv4 address

Ví dụ: 13.212.45.123
```

**Bước 2: Cấu hình PuTTY**
```
1. Mở PuTTY
2. Session:
   - Host Name: ubuntu@13.212.45.123
   - Port: 22
   - Connection type: SSH

3. Connection → SSH → Auth:
   - Private key file: Browse → Chọn student-app-key.ppk

4. Session:
   - Saved Sessions: "AWS-StudentApp"
   - Click "Save"

5. Click "Open" để kết nối
```

**Kết quả:**
```bash
login as: ubuntu
Authenticating with public key "imported-openssh-key"
Welcome to Ubuntu 22.04.3 LTS (GNU/Linux 6.2.0-1016-aws x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

ubuntu@ip-172-31-12-34:~$ 
```

---

## 5.5.3. Cài đặt môi trường server

### a) Update hệ thống

```bash
# Update package list
sudo apt update

# Upgrade installed packages
sudo apt upgrade -y

# Install basic utilities
sudo apt install -y \
    curl \
    wget \
    git \
    vim \
    htop \
    net-tools \
    ufw
```

### b) Cài đặt Docker

**Bước 1: Gỡ cài đặt cũ (nếu có)**
```bash
sudo apt remove docker docker-engine docker.io containerd runc
```

**Bước 2: Cài đặt Docker**
```bash
# Add Docker's official GPG key
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

# Add Docker repository
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# Install Docker Engine
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# Verify installation
docker --version
# Output: Docker version 24.0.7, build afdd53b
```

**Bước 3: Cấu hình Docker permissions**
```bash
# Add current user to docker group
sudo usermod -aG docker $USER

# Apply group changes (hoặc logout/login)
newgrp docker

# Test Docker without sudo
docker ps
# Output: CONTAINER ID   IMAGE   COMMAND   CREATED   STATUS   PORTS   NAMES
```

### c) Cài đặt Docker Compose

```bash
# Docker Compose v2 đã được cài với Docker plugin
docker compose version
# Output: Docker Compose version v2.23.0

# Tạo alias cho compatibility (optional)
echo 'alias docker-compose="docker compose"' >> ~/.bashrc
source ~/.bashrc
```

### d) Cài đặt Nginx

```bash
# Install Nginx
sudo apt install -y nginx

# Start Nginx
sudo systemctl start nginx

# Enable auto-start on boot
sudo systemctl enable nginx

# Check status
sudo systemctl status nginx

# Verify web server (truy cập http://PUBLIC_IP từ browser)
curl http://localhost
# Output: Welcome to nginx!
```

### e) Cấu hình Firewall (UFW)

```bash
# Enable UFW
sudo ufw enable

# Allow OpenSSH (QUAN TRỌNG: Làm trước để không bị kick)
sudo ufw allow OpenSSH

# Allow HTTP and HTTPS
sudo ufw allow 'Nginx Full'

# Allow custom ports (development)
sudo ufw allow 3000/tcp
sudo ufw allow 3001/tcp

# Deny PostgreSQL từ internet (chỉ allow local)
sudo ufw deny 5432/tcp

# Check status
sudo ufw status verbose

# Output:
# Status: active
# To                         Action      From
# --                         ------      ----
# 22/tcp                     ALLOW       Anywhere
# 80,443/tcp (Nginx Full)   ALLOW       Anywhere
# 3000/tcp                   ALLOW       Anywhere
# 3001/tcp                   ALLOW       Anywhere
```

---

## 5.5.4. Cấu hình domain name

### a) Mua domain hoatdongrenluyen.io.vn

```
1. Nhà cung cấp: NIC.VN, PA Vietnam, hoặc Tên Miền Việt Nam
2. Domain: hoatdongrenluyen.io.vn
3. Thời hạn: 1 năm (hoặc lâu hơn)
4. Chi phí: ~300,000 - 500,000 VNĐ/năm
```

### b) Cấu hình DNS Records

**Truy cập DNS Management Panel:**
```
1. Đăng nhập vào trang quản lý domain
2. Vào mục "DNS Management" hoặc "Quản lý DNS"
```

**Thêm A Records:**

| Type | Name | Value (IP Address) | TTL |
|------|------|-------------------|-----|
| A | @ | 13.212.45.123 | 3600 |
| A | www | 13.212.45.123 | 3600 |

**Giải thích:**
- `@` = root domain (hoatdongrenluyen.io.vn)
- `www` = subdomain (www.hoatdongrenluyen.io.vn)
- IP = Public IPv4 address của EC2 instance
- TTL = Time To Live (3600s = 1 hour)

### c) Kiểm tra DNS propagation

```bash
# Trên máy local (Windows CMD hoặc PowerShell)
nslookup hoatdongrenluyen.io.vn

# Output mong muốn:
# Server:  dns.google
# Address:  8.8.8.8
#
# Non-authoritative answer:
# Name:    hoatdongrenluyen.io.vn
# Address:  13.212.45.123

# Kiểm tra www subdomain
nslookup www.hoatdongrenluyen.io.vn

# Online tool: https://dnschecker.org/
# Nhập: hoatdongrenluyen.io.vn
# Kiểm tra propagation trên nhiều location
```

**Thời gian propagation:**
- Local ISP: 5-30 phút
- Global: 24-48 giờ (thường < 6 giờ)

---

## 5.5.5. Clone source code từ GitHub

### a) Tạo SSH key trên server

```bash
# Generate SSH key
ssh-keygen -t ed25519 -C "server@hoatdongrenluyen.io.vn"

# Output:
# Generating public/private ed25519 key pair.
# Enter file in which to save the key (/home/ubuntu/.ssh/id_ed25519): [Enter]
# Enter passphrase (empty for no passphrase): [Enter]
# Your public key has been saved in /home/ubuntu/.ssh/id_ed25519.pub

# Copy public key
cat ~/.ssh/id_ed25519.pub

# Output (copy toàn bộ):
# ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJk... server@hoatdongrenluyen.io.vn
```

### b) Thêm SSH key vào GitHub

```
1. Đăng nhập GitHub: https://github.com
2. Settings → SSH and GPG keys → New SSH key
3. Title: "AWS EC2 Production Server"
4. Key type: Authentication Key
5. Key: Paste public key vừa copy
6. Click "Add SSH key"
```

### c) Clone repository

```bash
# Tạo thư mục project
mkdir -p ~/projects
cd ~/projects

# Clone từ GitHub (sử dụng SSH)
git clone git@github.com:Jiipi/QL_DH_RenLuyen.git
cd QL_DH_RenLuyen

# Verify
ls -la
# Output: backend/ frontend/ docker-compose.yml README.md ...

# Check branch
git branch
# Output: * main
```

### d) Cấu hình Git (optional)

```bash
# Set user info
git config --global user.name "Production Server"
git config --global user.email "server@hoatdongrenluyen.io.vn"

# Set default branch
git config --global init.defaultBranch main

# Check config
git config --list
```

---

## 5.5.6. Cấu hình environment variables

### a) Tạo file .env cho production

```bash
cd ~/projects/QL_DH_RenLuyen

# Tạo .env file
nano .env
```

**Nội dung file .env:**

```bash
# ============================================
# PRODUCTION ENVIRONMENT VARIABLES
# hoatdongrenluyen.io.vn
# ============================================

# Node Environment
NODE_ENV=production

# Database Configuration
DB_NAME=Web_QuanLyDiemRenLuyen
DB_USER=admin
DB_PASSWORD=YourSecurePassword123!@#
DATABASE_URL=postgresql://admin:YourSecurePassword123!@#@db:5432/Web_QuanLyDiemRenLuyen?schema=public

# Backend API
PORT=3001

# JWT Configuration
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production-min-32-chars
JWT_EXPIRES_IN=7d
JWT_REFRESH_EXPIRES_IN=30d

# CORS Configuration
CORS_ORIGIN=https://hoatdongrenluyen.io.vn,https://www.hoatdongrenluyen.io.vn

# Frontend Configuration
REACT_APP_API_URL=https://hoatdongrenluyen.io.vn/api

# Email Configuration (Optional)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-specific-password
EMAIL_FROM=no-reply@hoatdongrenluyen.io.vn

# Upload Configuration
MAX_FILE_SIZE=10485760
UPLOAD_DIR=/app/backend/uploads

# Logging
LOG_LEVEL=info
LOG_DIR=/app/backend/logs

# Session
SESSION_SECRET=your-session-secret-key-change-this

# Rate Limiting
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100

# Pagination
DEFAULT_PAGE_SIZE=20
MAX_PAGE_SIZE=100
```

**Lưu file:**
```bash
# Ctrl + O → Enter → Ctrl + X (nano editor)
```

**Set file permissions:**
```bash
chmod 600 .env
ls -la .env
# Output: -rw------- 1 ubuntu ubuntu 1234 Oct 29 10:30 .env
```

### b) Generate secure secrets

```bash
# Generate JWT_SECRET (32+ characters)
openssl rand -base64 32
# Output: Kj8sN2mP9qR4tV7wX0zA3bC5dF8gH1iJ6kL9mN2oP5qR==

# Generate SESSION_SECRET
openssl rand -hex 32
# Output: 5f8a9b2c4d6e1f3a7b9c0d2e4f6a8b1c3d5e7f9a1b3c5d7e9f0a2b4c6d8e0f2

# Update .env với secrets vừa generate
nano .env
# Copy/paste secrets mới
```

---

## 5.5.7. Build và chạy ứng dụng với Docker

### a) Kiểm tra docker-compose.yml

```bash
cd ~/projects/QL_DH_RenLuyen

# Xem nội dung file
cat docker-compose.yml

# Validate syntax
docker compose config
```

### b) Build Docker images

```bash
# Build all services (lần đầu tiên, mất ~10-15 phút)
docker compose build

# Output:
# [+] Building 450.2s (25/25) FINISHED
#  => [backend internal] load build definition from Dockerfile
#  => => transferring dockerfile: 1.23kB
#  => [backend internal] load .dockerignore
#  => [backend] FROM docker.io/library/node:18-alpine
#  => ...
#  => [frontend] npm run build
#  => exporting to image
#  => => naming to docker.io/library/ql_dh_renluyen-backend

# Kiểm tra images đã build
docker images

# Output:
# REPOSITORY                    TAG       IMAGE ID       CREATED         SIZE
# ql_dh_renluyen-backend       latest    abc123def456   2 minutes ago   850MB
# ql_dh_renluyen-frontend      latest    def456abc789   3 minutes ago   120MB
# postgres                      15        789abc123def   2 weeks ago     412MB
```

### c) Start services

```bash
# Start tất cả containers (detached mode)
docker compose up -d

# Output:
# [+] Running 4/4
#  ✔ Network ql_dh_renluyen_default       Created   0.1s
#  ✔ Volume "ql_dh_renluyen_pgdata"       Created   0.0s
#  ✔ Container ql_dh_renluyen-db-1        Started   2.3s
#  ✔ Container ql_dh_renluyen-backend-1   Started   4.5s
#  ✔ Container ql_dh_renluyen-frontend-1  Started   5.1s

# Kiểm tra containers đang chạy
docker compose ps

# Output:
# NAME                          IMAGE                      STATUS          PORTS
# ql_dh_renluyen-db-1          postgres:15                Up 30 seconds   0.0.0.0:5432->5432/tcp
# ql_dh_renluyen-backend-1     ql_dh_renluyen-backend    Up 28 seconds   0.0.0.0:3001->3001/tcp
# ql_dh_renluyen-frontend-1    ql_dh_renluyen-frontend   Up 27 seconds   0.0.0.0:3000->3000/tcp
```

### d) Kiểm tra logs

```bash
# Xem logs của tất cả services
docker compose logs

# Xem logs real-time (follow)
docker compose logs -f

# Xem logs của service cụ thể
docker compose logs backend
docker compose logs db
docker compose logs frontend

# Xem 100 dòng cuối
docker compose logs --tail=100

# Lọc logs theo thời gian
docker compose logs --since 30m
```

### e) Verify services health

```bash
# Test backend API
curl http://localhost:3001/api/health
# Output: {"status":"ok","timestamp":"2025-10-29T10:45:23.456Z"}

# Test frontend
curl http://localhost:3000
# Output: HTML content của React app

# Test database connection
docker compose exec db psql -U admin -d Web_QuanLyDiemRenLuyen -c "SELECT version();"
# Output: PostgreSQL 15.x on x86_64-pc-linux-gnu
```

---

## 5.5.8. Cấu hình Nginx reverse proxy

### a) Tạo Nginx config file

```bash
# Tạo config file
sudo nano /etc/nginx/sites-available/hoatdongrenluyen
```

**Nội dung file:**

```nginx
# Redirect HTTP to HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name hoatdongrenluyen.io.vn www.hoatdongrenluyen.io.vn;

    # Certbot challenge (cho Let's Encrypt)
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Redirect tất cả request sang HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPS server
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name hoatdongrenluyen.io.vn www.hoatdongrenluyen.io.vn;

    # SSL certificates (sẽ được tạo bởi Certbot)
    ssl_certificate /etc/letsencrypt/live/hoatdongrenluyen.io.vn/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/hoatdongrenluyen.io.vn/privkey.pem;
    
    # SSL settings (modern configuration)
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_stapling on;
    ssl_stapling_verify on;

    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/json application/xml+rss image/svg+xml;

    # Client body size (file uploads)
    client_max_body_size 10M;

    # Frontend (React SPA)
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Backend API
    location /api {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # API timeouts (longer for complex queries)
        proxy_connect_timeout 90s;
        proxy_send_timeout 90s;
        proxy_read_timeout 90s;
    }

    # Static files caching
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://localhost:3000;
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Logs
    access_log /var/log/nginx/hoatdongrenluyen-access.log;
    error_log /var/log/nginx/hoatdongrenluyen-error.log;
}
```

**Lưu file:** Ctrl + O → Enter → Ctrl + X

### b) Enable site

```bash
# Tạo symbolic link
sudo ln -s /etc/nginx/sites-available/hoatdongrenluyen /etc/nginx/sites-enabled/

# Xóa default site (optional)
sudo rm /etc/nginx/sites-enabled/default

# Test cấu hình
sudo nginx -t

# Output:
# nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
# nginx: configuration file /etc/nginx/nginx.conf test is successful

# Reload Nginx
sudo systemctl reload nginx
```

---

## 5.5.9. Cài đặt SSL certificate với Let's Encrypt

### a) Cài đặt Certbot

```bash
# Install Certbot và Nginx plugin
sudo apt install -y certbot python3-certbot-nginx

# Verify installation
certbot --version
# Output: certbot 2.7.4
```

### b) Tạo thư mục cho ACME challenge

```bash
# Tạo thư mục
sudo mkdir -p /var/www/certbot

# Set permissions
sudo chown -R www-data:www-data /var/www/certbot
```

### c) Request SSL certificate

```bash
# Request certificate cho domain
sudo certbot --nginx -d hoatdongrenluyen.io.vn -d www.hoatdongrenluyen.io.vn

# Certbot sẽ hỏi:
# Enter email address: your-email@example.com
# Agree to Terms of Service: Yes (Y)
# Share email with EFF: No (N)
# Redirect HTTP to HTTPS: Yes (2)

# Output:
# Congratulations! You have successfully enabled HTTPS on 
# https://hoatdongrenluyen.io.vn and https://www.hoatdongrenluyen.io.vn
#
# Certificate is saved at: /etc/letsencrypt/live/hoatdongrenluyen.io.vn/fullchain.pem
# Key is saved at:         /etc/letsencrypt/live/hoatdongrenluyen.io.vn/privkey.pem
# Expiry Date: 2026-01-27 10:30:00+00:00 (90 days)
```

### d) Test SSL configuration

```bash
# Test certificate
sudo certbot certificates

# Output:
# Found the following certs:
#   Certificate Name: hoatdongrenluyen.io.vn
#     Domains: hoatdongrenluyen.io.vn www.hoatdongrenluyen.io.vn
#     Expiry Date: 2026-01-27 10:30:00+00:00 (VALID: 89 days)
#     Certificate Path: /etc/letsencrypt/live/hoatdongrenluyen.io.vn/fullchain.pem
#     Private Key Path: /etc/letsencrypt/live/hoatdongrenluyen.io.vn/privkey.pem

# Test SSL với browser
# Truy cập: https://hoatdongrenluyen.io.vn
# Kiểm tra lock icon, certificate valid
```

### e) Cấu hình auto-renewal

```bash
# Test auto-renewal (dry run)
sudo certbot renew --dry-run

# Output:
# Congratulations, all simulated renewals succeeded:
#   /etc/letsencrypt/live/hoatdongrenluyen.io.vn/fullchain.pem (success)

# Certbot tự động tạo cron job
# Kiểm tra:
sudo systemctl status certbot.timer

# Output:
# ● certbot.timer - Run certbot twice daily
#      Loaded: loaded (/lib/systemd/system/certbot.timer; enabled)
#      Active: active (waiting)
```

**Cron job tự động:**
```
Certbot kiểm tra renewal 2 lần/ngày
Certificate sẽ được renew khi còn < 30 ngày
```

---

## 5.5.10. Database migration và seeding

### a) Chạy Prisma migrations

```bash
cd ~/projects/QL_DH_RenLuyen

# Exec vào backend container
docker compose exec backend sh

# Trong container:
cd /app/backend

# Generate Prisma Client
npx prisma generate

# Push database schema
npx prisma db push

# Output:
# Your database is now in sync with your schema.
# ✔ Generated Prisma Client

# Exit container
exit
```

### b) Seed initial data

```bash
# Check có seed script không
cat backend/package.json | grep seed

# Nếu có prisma:seed script:
docker compose exec backend npm run seed

# Hoặc chạy seed file trực tiếp
docker compose exec backend node backend/scripts/seed.js
```

### c) Verify database

```bash
# Connect to PostgreSQL
docker compose exec db psql -U admin -d Web_QuanLyDiemRenLuyen

# Kiểm tra tables
\dt

# Output:
#              List of relations
# Schema |      Name       | Type  | Owner 
# --------+-----------------+-------+-------
# public | _prisma...      | table | admin
# public | dang_ky_hoat... | table | admin
# public | diem_danh       | table | admin
# public | hoat_dong       | table | admin
# public | lop             | table | admin
# public | nguoi_dung      | table | admin
# public | sinh_vien       | table | admin
# public | thong_bao       | table | admin
# public | vai_tro         | table | admin

# Kiểm tra số lượng users
SELECT COUNT(*) FROM nguoi_dung;

# Output:
#  count 
# -------
#    245

# Exit PostgreSQL
\q
```

---

## 5.5.11. Upload file với WinSCP

### a) Cài đặt và cấu hình WinSCP

**Download:**
```
URL: https://winscp.net/eng/download.php
File: WinSCP-X.XX.X-Setup.exe
Install: C:\Program Files\WinSCP\
```

**Cấu hình connection:**
```
1. File protocol: SFTP
2. Host name: 13.212.45.123 (Public IP của EC2)
3. Port number: 22
4. User name: ubuntu
5. Password: (để trống)

6. Advanced → SSH → Authentication:
   - Private key file: C:\Users\...\AWS\student-app-key.ppk

7. Save → Login
```

### b) Upload/Download files

**Upload file:**
```
Local (Left panel): C:\Users\YourName\project\
Remote (Right panel): /home/ubuntu/projects/QL_DH_RenLuyen/

Cách 1: Drag & drop files từ left sang right
Cách 2: Right-click → Upload
Cách 3: F5 (Copy)
```

**Use cases:**
```
1. Upload .env file mới
2. Upload images/assets
3. Download logs để debug
4. Backup database dumps
5. Upload SSL certificates (manual)
```

### c) Synchronize directories

```
1. Commands → Synchronize
2. Direction: 
   - Local → Remote (upload changes)
   - Remote → Local (download changes)
   - Both (sync both ways)
3. Mode:
   - Synchronize files
   - Mirror files (delete extra)
4. Options:
   - Preview changes
   - Compare by size and time
5. Click OK
```

---

## 5.5.12. Monitoring và logging

### a) Check service status

```bash
# Docker containers
docker compose ps

# Nginx
sudo systemctl status nginx

# System resources
htop

# Disk usage
df -h

# Memory usage
free -h

# Network connections
sudo netstat -tulpn | grep LISTEN
```

### b) View logs

**Application logs:**
```bash
# Backend logs (trong container)
docker compose logs backend --tail=100 -f

# Frontend logs
docker compose logs frontend --tail=100 -f

# Database logs
docker compose logs db --tail=50

# All services
docker compose logs --tail=200 -f
```

**Nginx logs:**
```bash
# Access logs
sudo tail -f /var/log/nginx/hoatdongrenluyen-access.log

# Error logs
sudo tail -f /var/log/nginx/hoatdongrenluyen-error.log

# Grep specific pattern
sudo grep "POST /api/auth/login" /var/log/nginx/hoatdongrenluyen-access.log
```

**System logs:**
```bash
# System messages
sudo tail -f /var/log/syslog

# Authentication logs
sudo tail -f /var/log/auth.log

# Kernel logs
dmesg | tail -50
```

### c) Disk space management

```bash
# Check disk usage
df -h /

# Find large directories
du -h /home/ubuntu | sort -rh | head -20

# Docker system usage
docker system df

# Clean up old images
docker image prune -a

# Clean up old containers
docker container prune

# Clean up volumes (CAREFUL!)
docker volume prune
```

---

## 5.5.13. Backup và restore

### a) Backup database

**Script backup tự động:**

```bash
# Tạo script backup
nano ~/backup_db.sh
```

**Nội dung script:**

```bash
#!/bin/bash

# Database backup script
BACKUP_DIR="/home/ubuntu/backups"
DATE=$(date +"%Y%m%d_%H%M%S")
DB_NAME="Web_QuanLyDiemRenLuyen"
BACKUP_FILE="$BACKUP_DIR/db_backup_$DATE.sql.gz"

# Create backup directory
mkdir -p $BACKUP_DIR

# Run backup
docker compose exec -T db pg_dump -U admin $DB_NAME | gzip > $BACKUP_FILE

# Keep only last 7 days
find $BACKUP_DIR -name "db_backup_*.sql.gz" -mtime +7 -delete

echo "Backup completed: $BACKUP_FILE"
```

**Set permissions và chạy:**
```bash
chmod +x ~/backup_db.sh
./backup_db.sh

# Output: Backup completed: /home/ubuntu/backups/db_backup_20251029_103045.sql.gz
```

**Cron job tự động (backup hàng ngày lúc 2AM):**
```bash
crontab -e

# Thêm dòng:
0 2 * * * /home/ubuntu/backup_db.sh >> /home/ubuntu/backup.log 2>&1
```

### b) Restore database

```bash
# Stop backend để không có connections
docker compose stop backend

# Restore từ backup file
gunzip -c /home/ubuntu/backups/db_backup_20251029_103045.sql.gz | \
  docker compose exec -T db psql -U admin -d Web_QuanLyDiemRenLuyen

# Start backend lại
docker compose start backend

# Verify
docker compose exec db psql -U admin -d Web_QuanLyDiemRenLuyen -c "SELECT COUNT(*) FROM nguoi_dung;"
```

### c) Backup uploads và logs

```bash
# Backup uploads
tar -czf ~/backups/uploads_$(date +%Y%m%d).tar.gz \
  ~/projects/QL_DH_RenLuyen/backend/uploads

# Backup logs
tar -czf ~/backups/logs_$(date +%Y%m%d).tar.gz \
  ~/projects/QL_DH_RenLuyen/backend/logs

# Download về local với WinSCP
# hoặc sync với S3:
# aws s3 sync ~/backups s3://your-bucket/backups/
```

---

## 5.5.14. Update và deployment workflow

### a) Quy trình update code

```bash
cd ~/projects/QL_DH_RenLuyen

# 1. Pull latest code từ GitHub
git pull origin main

# Output:
# From github.com:Jiipi/QL_DH_RenLuyen
#  * branch            main       -> FETCH_HEAD
# Updating abc123..def456
# Fast-forward
#  backend/src/controllers/activities.js | 15 ++++++++++++---
#  frontend/src/pages/Activities.js      | 8 +++++++-
#  2 files changed, 19 insertions(+), 4 deletions(-)

# 2. Rebuild Docker images
docker compose build

# 3. Stop old containers
docker compose down

# 4. Start new containers
docker compose up -d

# 5. Check logs
docker compose logs -f --tail=100
```

### b) Zero-downtime deployment (advanced)

```bash
# Build new image với tag mới
docker compose build --build-arg FRONTEND_BUILD_ID=$(date +%s)

# Start new containers với tên mới (blue-green deployment)
docker compose -p ql_dh_renluyen_new up -d

# Test new deployment
curl http://localhost:3002/api/health

# Switch Nginx upstream
sudo nano /etc/nginx/sites-available/hoatdongrenluyen
# Change port 3000 → 3002

# Reload Nginx
sudo systemctl reload nginx

# Stop old containers
docker compose -p ql_dh_renluyen_old down
```

### c) Rollback

```bash
# Check commit history
git log --oneline -10

# Rollback to previous commit
git reset --hard abc123

# Rebuild và restart
docker compose build
docker compose down
docker compose up -d

# Restore database từ backup (nếu cần)
gunzip -c ~/backups/db_backup_20251028_020000.sql.gz | \
  docker compose exec -T db psql -U admin -d Web_QuanLyDiemRenLuyen
```

---

## 5.5.15. Troubleshooting

### a) Website không accessible

**Kiểm tra:**
```bash
# 1. Check Docker containers
docker compose ps
# Tất cả phải "Up"

# 2. Check Nginx
sudo systemctl status nginx
sudo nginx -t

# 3. Check firewall
sudo ufw status

# 4. Check DNS
nslookup hoatdongrenluyen.io.vn

# 5. Check security group (AWS Console)
# Port 80, 443 phải allow từ 0.0.0.0/0
```

### b) Backend API lỗi 500

```bash
# Check backend logs
docker compose logs backend --tail=200

# Check database connection
docker compose exec backend node -e "
const { PrismaClient } = require('@prisma/client');
const prisma = new PrismaClient();
prisma.\$connect().then(() => console.log('DB OK')).catch(e => console.error(e));
"

# Check environment variables
docker compose exec backend printenv | grep DATABASE_URL
```

### c) Database connection failed

```bash
# Check database container
docker compose ps db

# Check database logs
docker compose logs db --tail=50

# Test connection
docker compose exec db psql -U admin -d Web_QuanLyDiemRenLuyen -c "SELECT 1;"

# Check network
docker network inspect ql_dh_renluyen_default
```

### d) SSL certificate errors

```bash
# Check certificate
sudo certbot certificates

# Test renewal
sudo certbot renew --dry-run

# Check Nginx SSL config
sudo nginx -t

# View certificate details
openssl s_client -connect hoatdongrenluyen.io.vn:443 -servername hoatdongrenluyen.io.vn
```

---

## 5.5.16. Security best practices

### a) Update packages thường xuyên

```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Update Docker images
docker compose pull
docker compose up -d
```

### b) Configure fail2ban

```bash
# Install fail2ban
sudo apt install -y fail2ban

# Configure SSH protection
sudo nano /etc/fail2ban/jail.local
```

**Nội dung:**
```ini
[sshd]
enabled = true
port = 22
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 3600
findtime = 600
```

```bash
# Start fail2ban
sudo systemctl enable fail2ban
sudo systemctl start fail2ban

# Check status
sudo fail2ban-client status sshd
```

### c) Limit SSH access

```bash
# Edit SSH config
sudo nano /etc/ssh/sshd_config
```

**Changes:**
```
PermitRootLogin no
PasswordAuthentication no
PubkeyAuthentication yes
AllowUsers ubuntu
```

```bash
# Restart SSH
sudo systemctl restart sshd
```

### d) Setup log rotation

```bash
# Configure logrotate for app logs
sudo nano /etc/logrotate.d/hoatdongrenluyen
```

**Nội dung:**
```
/home/ubuntu/projects/QL_DH_RenLuyen/backend/logs/*.log {
    daily
    rotate 7
    compress
    delaycompress
    notifempty
    create 0640 ubuntu ubuntu
    sharedscripts
}

/var/log/nginx/hoatdongrenluyen-*.log {
    daily
    rotate 14
    compress
    delaycompress
    notifempty
    sharedscripts
    postrotate
        systemctl reload nginx > /dev/null
    endscript
}
```

---

## Tổng kết

### Quy trình deployment hoàn chỉnh:

```
1. ✅ Chuẩn bị AWS EC2 instance
2. ✅ Cài đặt môi trường (Docker, Nginx, Certbot)
3. ✅ Cấu hình domain DNS
4. ✅ Clone source code từ GitHub
5. ✅ Cấu hình environment variables
6. ✅ Build và chạy Docker containers
7. ✅ Setup Nginx reverse proxy
8. ✅ Cài đặt SSL certificate
9. ✅ Database migration và seeding
10. ✅ Setup monitoring và backup
11. ✅ Test và verify deployment
```

### Công cụ sử dụng:

| Công cụ | Mục đích | Platform |
|---------|----------|----------|
| PuTTY | SSH connection | Windows |
| WinSCP | File transfer (SFTP) | Windows |
| AWS Console | Manage EC2 instance | Web |
| GitHub | Version control | Web/Git |
| Docker | Containerization | Linux |
| Nginx | Reverse proxy | Linux |
| Certbot | SSL certificates | Linux |
| PostgreSQL | Database | Docker |

### Checklist sau deployment:

- [ ] Website accessible qua HTTPS
- [ ] SSL certificate valid (green lock)
- [ ] Login functionality works
- [ ] API endpoints respond correctly
- [ ] Database contains seed data
- [ ] Auto-backup cron job active
- [ ] Monitoring logs configured
- [ ] Firewall rules secured
- [ ] DNS propagated globally
- [ ] Performance acceptable (< 2s load time)

---

**Ngày hoàn thành:** 29/10/2025  
**Domain:** https://hoatdongrenluyen.io.vn  
**Server:** AWS EC2 (Ubuntu 22.04)  
**Status:** Production Ready ✅
